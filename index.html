<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端音频处理工具 - 基于FFmpeg.wasm</title>
    <style>
        /* 语言切换按钮样式 */
        .language-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .language-switch button {
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: auto;
            margin: 0;
        }
        
        .language-switch button:hover {
            background-color: #e9ecef;
        }
        
        .language-switch button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* 适配移动端 */
        @media (max-width: 600px) {
            .language-switch {
                position: static;
                margin-bottom: 1rem;
                justify-content: center;
            }
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .container {
            margin-top: 2rem;
        }
        .form-group {
            margin: 1.5rem 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        select, input, button, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 1rem;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .module {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .audio-item {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px dashed #ccc;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .audio-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }
        
        .audio-item.dragging {
            opacity: 0.5;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        
        .file-type-indicator {
            margin-right: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }
        
        .file-name {
            flex-grow: 1;
            margin-right: 0.5rem;
            word-break: break-all;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            width: auto;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .item-controls {
            padding-left: 1rem;
        }
        
        .trim-controls {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
        }
        
        .trim-progress-container {
            position: relative;
            height: 40px;
            margin-bottom: 1rem;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .trim-slider {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            background: transparent;
            cursor: pointer;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            pointer-events: none;
        }
        
        /* 滑块轨道样式 - 禁止点击 */
        .trim-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: default;
        }
        
        .trim-slider::-moz-range-track {
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: default;
        }
        
        /* 滑块 thumb 样式 - 三角顶针型 */
        .trim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 10px solid #007bff;
            cursor: pointer;
            z-index: 3;
            transform: translateY(5px);
            pointer-events: auto;
        }
        
        .trim-slider::-moz-range-thumb {
            width: 10px;
            height: 20px;
            background: transparent;
            cursor: pointer;
            border: none;
            z-index: 3;
            /* Firefox 使用背景图片模拟三角形 */
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='20' viewBox='0 0 10 20'><polygon points='0,0 10,0 5,20' fill='%23007bff'/></svg>");
            background-size: 100% 100%;
            pointer-events: auto;
        }
        
        /* 开始滑块样式 - 显示为向下三角形 */
        .trim-slider.start-slider::-webkit-slider-thumb {
            border-top: none;
            border-bottom: 10px solid #007bff;
            transform: translateY(-5px);
        }
        
        /* Firefox 开始滑块样式 */
        .trim-slider.start-slider::-moz-range-thumb {
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='20' viewBox='0 0 10 20'><polygon points='0,20 10,20 5,0' fill='%23007bff'/></svg>");
        }
        
        /* 开始滑块样式 */
        .trim-slider.start-slider {
            z-index: 2;
        }
        
        /* 结束滑块样式 */
        .trim-slider.end-slider {
            z-index: 2;
        }
        
        .trim-progress-bar {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: #007bff;
            opacity: 0.5;
            z-index: 0;
        }
        
        .trim-time-inputs {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .trim-time-inputs label {
            margin: 0;
            font-size: 0.9rem;
        }
        
        .trim-time-inputs input {
            width: 130px;
            margin: 0;
        }
        
        /* 移动端响应式设计 */
        @media (max-width: 600px) {
            .trim-time-inputs {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .trim-time-inputs > div {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: 100%;
            }
            
            .trim-time-inputs label {
                width: 80px;
            }
            
            .trim-time-inputs input {
                flex: 1;
                min-width: 150px;
            }
        }
        
        .play-btn, .pause-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
            width: auto;
        }
        
        .pause-btn {
            background-color: #ffc107;
            color: #212529;
        }
        
        .play-btn:hover {
            background-color: #218838;
        }
        
        .pause-btn:hover {
            background-color: #e0a800;
        }
        .progress {
            margin: 1rem 0;
            height: 20px;
            border-radius: 10px;
            background-color: #eee;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: #28a745;
            transition: width 0.3s;
        }
        .hidden {
            display: none;
        }
        .command-group {
            margin: 2rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        h1 {
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- 语言切换按钮 -->
    <div class="language-switch">
        <button id="lang-zh" class="active">中文</button>
        <button id="lang-en">English</button>
    </div>
    
    <h1 data-i18n="title">前端音频处理工具</h1>
    <div class="form-group">
        <label for="function-select" data-i18n="select_function">选择功能</label>
        <select id="function-select">
            <option value="" data-i18n="please_select_function">--请选择功能--</option>
            <option value="convert" data-i18n="convert_format_option">[音频/视频]转换格式(音频提取、音频视频格式转换)</option>
            <option value="merge-volume" data-i18n="merge_volume_option">[音频/视频]截取、拼接与调整音量</option>
        </select>
    </div>

    <!-- 转换格式模块 -->
    <div id="convert-module" class="module hidden">
        <h2 data-i18n="convert_format_title">[音频/视频]转换格式</h2>
        <div class="form-group">
            <label for="convert-file" data-i18n="select_file">选择文件</label>
            <input type="file" id="convert-file" accept="audio/*,video/*">
        </div>
        <div class="form-group">
            <label for="convert-format" data-i18n="target_format">目标格式</label>
            <select id="convert-format">
                <!-- 选项将根据选择的文件类型动态生成 -->
            </select>
        </div>
        <div class="progress">
            <div id="convert-progress" class="progress-bar"></div>
        </div>
        <button id="generate-convert-command" type="button" data-i18n="generate_ffmpeg_command">生成FFmpeg命令</button>
    </div>

    <!-- 截取、拼接与调整音量模块 -->
    <div id="merge-volume-module" class="module hidden">
        <h2 data-i18n="merge_volume_title">[音频/视频]截取、拼接与调整音量</h2>
        <div class="form-group">
            <label for="merge-files" data-i18n="select_files">选择文件</label>
            <input type="file" id="merge-files" accept="audio/*,video/*" multiple>
        </div>
        <div id="audio-items-container"></div>
        <div class="progress">
            <div id="merge-volume-progress" class="progress-bar"></div>
        </div>
        <button id="add-more-files" type="button" data-i18n="add_more_files">添加文件</button>
        <button id="generate-merge-volume-command" type="button" data-i18n="generate_ffmpeg_command">生成FFmpeg命令</button>
    </div>

    <!-- FFmpeg命令预览与编辑 -->
    <div class="command-group hidden" id="command-group">
        <label for="ffmpeg-command" data-i18n="ffmpeg_command_label">FFmpeg 命令（可手动修改）</label>
        <textarea id="ffmpeg-command" readonly placeholder="FFmpeg命令将在此处生成..."></textarea>
        <button id="confirm-command" type="button" data-i18n="confirm_and_execute">确认命令并执行</button>
    </div>

    <script type="module">
        // 使用本地FFmpeg依赖
        import { FFmpeg } from './static/ffmpeg/ffmpeg/index.js';
        
        // 翻译映射
        const translations = {
            // 中文翻译
            zh: {
                title: '前端音频处理工具',
                select_function: '选择功能',
                please_select_function: '--请选择功能--',
                convert_format_option: '[音频/视频]转换格式(音频提取、音频视频格式转换)',
                merge_volume_option: '[音频/视频]截取、拼接与调整音量',
                convert_format_title: '[音频/视频]转换格式',
                select_file: '选择文件',
                target_format: '目标格式',
                generate_ffmpeg_command: '生成FFmpeg命令',
                merge_volume_title: '[音频/视频]截取、拼接与调整音量',
                select_files: '选择文件',
                add_more_files: '添加文件',
                ffmpeg_command_label: 'FFmpeg 命令（可手动修改）',
                confirm_and_execute: '确认命令并执行',
                volume_adjust: '音量调整（分贝，不输入则不调整，如 2 或 -3）',
                no_adjust: '不调整请留空',
                trim_settings: '截取设置',
                start_time: '开始时间：',
                end_time: '结束时间：',
                duration: '时长：',
                play: '播放',
                pause: '暂停',
                delete: '删除',
                video_label: '[视频]',
                audio_label: '[音频]',
                processing: '处理中...',
                processing_complete: '处理完成！文件已下载。',
                ffmpeg_loading: 'FFmpeg 正在加载中，请稍候！',
                execution_failed: '执行失败：'
            },
            // 英文翻译
            en: {
                title: 'Frontend Audio Processing Tool',
                select_function: 'Select Function',
                please_select_function: '--Please Select Function--',
                convert_format_option: '[Audio/Video] Convert Format (Extract Audio, Audio/Video Format Conversion)',
                merge_volume_option: '[Audio/Video] Trim, Merge & Adjust Volume',
                convert_format_title: '[Audio/Video] Convert Format',
                select_file: 'Select File',
                target_format: 'Target Format',
                generate_ffmpeg_command: 'Generate FFmpeg Command',
                merge_volume_title: '[Audio/Video] Trim, Merge & Adjust Volume',
                select_files: 'Select Files',
                add_more_files: 'Add More Files',
                ffmpeg_command_label: 'FFmpeg Command (Can be modified manually)',
                confirm_and_execute: 'Confirm Command & Execute',
                volume_adjust: 'Volume Adjustment (dB, leave blank for no adjustment, e.g., 2 or -3)',
                no_adjust: 'Leave blank for no adjustment',
                trim_settings: 'Trim Settings',
                start_time: 'Start Time:',
                end_time: 'End Time:',
                duration: 'Duration:',
                play: 'Play',
                pause: 'Pause',
                delete: 'Delete',
                video_label: '[Video]',
                audio_label: '[Audio]',
                processing: 'Processing...',
                processing_complete: 'Processing complete! File has been downloaded.',
                ffmpeg_loading: 'FFmpeg is loading, please wait!',
                execution_failed: 'Execution failed: '
            }
        };

        // 当前语言
        let currentLanguage = 'zh';

        // 翻译函数
        function translate() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            // 更新标题
            document.title = currentLanguage === 'zh' ? '前端音频处理工具 - 基于FFmpeg.wasm' : 'Frontend Audio Processing Tool - Based on FFmpeg.wasm';
            
            // 更新placeholder
            const ffmpegCommandInput = document.getElementById('ffmpeg-command');
            if (ffmpegCommandInput) {
                ffmpegCommandInput.placeholder = currentLanguage === 'zh' ? 'FFmpeg命令将在此处生成...' : 'FFmpeg command will be generated here...';
            }
        }

        // 初始化语言切换按钮事件
        document.getElementById('lang-zh').addEventListener('click', () => {
            currentLanguage = 'zh';
            document.getElementById('lang-zh').classList.add('active');
            document.getElementById('lang-en').classList.remove('active');
            translate();
        });

        document.getElementById('lang-en').addEventListener('click', () => {
            currentLanguage = 'en';
            document.getElementById('lang-en').classList.add('active');
            document.getElementById('lang-zh').classList.remove('active');
            translate();
        });
        
        const ffmpeg = new FFmpeg({ 
            log: true
        });
        
        // 用于存储FFmpeg日志
        let ffmpegLogs = [];
        
        // 添加日志监听器
        ffmpeg.on('log', (log) => {
            ffmpegLogs.push(log);
            console.log('FFmpeg日志:', log);
        });
        
        let ffmpegLoaded = false;
        let loadFFmpegPromise = null;
        // 存储当前功能的上下文数据
        let currentContext = {
            type: '',
            data: null,
            outputExt: ''
        };

        // DOM元素
        const functionSelect = document.getElementById('function-select');
        const commandGroup = document.getElementById('command-group');
        const ffmpegCommandInput = document.getElementById('ffmpeg-command');
        const confirmCommandBtn = document.getElementById('confirm-command');
        const convertModule = document.getElementById('convert-module');
        const mergeVolumeModule = document.getElementById('merge-volume-module');
        const audioItemsContainer = document.getElementById('audio-items-container');
        
        // 初始化翻译
        translate();

        // 功能切换
        functionSelect.addEventListener('change', (e) => {
            const value = e.target.value;
            convertModule.classList.add('hidden');
            mergeVolumeModule.classList.add('hidden');
            commandGroup.classList.add('hidden');
            audioItemsContainer.innerHTML = '';
            ffmpegCommandInput.value = '';
            currentContext = { type: '', data: null, outputExt: '' };
            
            if (value === 'convert') convertModule.classList.remove('hidden');
            else if (value === 'merge-volume') mergeVolumeModule.classList.remove('hidden');
            
            // 预加载FFmpeg
            if (!ffmpegLoaded) loadFFmpeg();
        });

        // 加载FFmpeg核心
        async function loadFFmpeg() {
            // 如果已经加载完成，直接返回
            if (ffmpegLoaded) {
                return;
            }
            
            // 如果已经有加载Promise在运行，返回该Promise
            if (loadFFmpegPromise) {
                return await loadFFmpegPromise;
            }
            
            // 创建新的加载Promise
            loadFFmpegPromise = (async () => {
                // 使用绝对URL，确保在模块类型worker中能正确加载
                const coreURL = `${window.location.origin}/static/ffmpeg/ffmpeg-core.js`;
                const wasmURL = `${window.location.origin}/static/ffmpeg/ffmpeg-core.wasm`;
                
                await ffmpeg.load({
                    coreURL: coreURL,
                    wasmURL: wasmURL,
                });
                ffmpegLoaded = true;
            })();
            
            // 等待加载完成
            await loadFFmpegPromise;
        }

        // 生成当前日期时间文件名
        function getOutputFileName(ext) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hour}${minute}${second}.${ext}`;
        }

        // ---------------------- 转换格式功能 ----------------------
        document.getElementById('convert-file').addEventListener('change', handleConvertFileSelect);
        document.getElementById('generate-convert-command').addEventListener('click', generateConvertCommand);

        // 支持的音频和视频格式
        const audioFormats = ['mp3', 'wav', 'flac', 'ogg', 'aac'];
        const videoFormats = ['mp4', 'avi', 'mov', 'webm'];

        // 根据输出格式获取合适的音频编码器
        function getAudioCodecForFormat(format) {
            switch(format) {
                case 'mp3':
                    return 'libmp3lame';
                case 'aac':
                    return 'aac';
                case 'flac':
                    return 'flac';
                case 'ogg':
                    return 'libvorbis';
                case 'wav':
                    return 'pcm_s16le';
                case 'mp4':
                case 'mov':
                case 'avi':
                case 'webm':
                    return 'aac'; // 视频格式默认使用aac音频编码
                default:
                    return 'copy';
            }
        }

        function handleConvertFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const convertFormatSelect = document.getElementById('convert-format');
            convertFormatSelect.innerHTML = '';

            // 检测文件类型
            const isVideo = file.type.startsWith('video/');
            const isAudio = file.type.startsWith('audio/');

            // 添加所有支持的格式选项
            if (isVideo || isAudio) {
                // 添加音频格式
                audioFormats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format.toUpperCase();
                    convertFormatSelect.appendChild(option);
                });
            }

            if (isVideo || isAudio) {
                // 添加视频格式
                videoFormats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format.toUpperCase();
                    convertFormatSelect.appendChild(option);
                });
            }

            validateConvertForm();
        }

        function validateConvertForm() {
            const file = document.getElementById('convert-file').files[0];
            const button = document.getElementById('generate-convert-command');
            button.disabled = !file;
        }

        async function generateConvertCommand() {
            const file = document.getElementById('convert-file').files[0];
            const format = document.getElementById('convert-format').value;
            const outputFileName = getOutputFileName(format);
            
            // 确保FFmpeg已经加载完成
            if (!ffmpegLoaded) {
                await loadFFmpeg();
            }
            
            // 写入文件
            const originalExt = file.name.split('.').pop();
            const inputName = `input.${originalExt}`;
            await ffmpeg.writeFile(inputName, new Uint8Array(await file.arrayBuffer()));
            
            // 检测文件类型和输出格式类型
            const isVideoInput = file.type.startsWith('video/');
            const isAudioInput = file.type.startsWith('audio/');
            const isAudioOutput = audioFormats.includes(format);
            const isVideoOutput = videoFormats.includes(format);
            
            // 生成FFmpeg命令
            const command = ['-i', inputName];
            
            if (isVideoInput && isAudioOutput) {
                // 视频转音频 - 提取音频
                command.push('-vn'); // 不包含视频
                if (audioFormats.includes(format)) {
                    // 如果输出是音频格式，使用适当的编码器
                    command.push('-c:a', getAudioCodecForFormat(format));
                } else {
                    command.push('-acodec', 'copy');
                }
            } else if (isAudioInput && isVideoOutput) {
                // 音频转视频 - 生成无画面视频
                command.push('-f', 'lavfi', '-i', 'color=c=black:s=16x16:r=1');
                command.push('-c:v', 'libx264');
                command.push('-c:a', getAudioCodecForFormat(format));
                command.push('-shortest');
            } else if (isAudioInput && isAudioOutput) {
                // 音频转音频 - 不同格式需要重新编码
                command.push('-c:a', getAudioCodecForFormat(format));
            } else if (isVideoInput && isVideoOutput) {
                // 视频转视频
                command.push('-c:v', 'libx264');
                command.push('-c:a', getAudioCodecForFormat(format));
            } else {
                // 其他情况 - 尝试直接复制
                command.push('-c', 'copy');
            }
            
            command.push(outputFileName);
            
            // 显示命令并存储上下文（添加ffmpeg前缀）
            ffmpegCommandInput.value = `ffmpeg ${command.join(' ')}`;
            ffmpegCommandInput.readOnly = false;
            commandGroup.classList.remove('hidden');
            currentContext = {
                type: 'convert',
                data: { progressBar: document.getElementById('convert-progress') },
                outputExt: format
            };
        }

        // ---------------------- 截取、拼接与调整音量功能 ----------------------
        document.getElementById('merge-files').addEventListener('change', handleMergeFilesSelect);
        document.getElementById('generate-merge-volume-command').addEventListener('click', generateMergeVolumeCommand);
        document.getElementById('add-more-files').addEventListener('click', () => {
            document.getElementById('merge-files').click();
        });

        // 存储当前选择的文件列表
        let selectedFiles = [];
        // 存储音频对象和时长
        let audioObjects = [];

        // 时间格式化函数：将秒数转换为HH:mm:ss.fff格式
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            const millis = Math.floor((seconds * 1000) % 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${millis.toString().padStart(3, '0')}`;
        }

        // 将格式化时间转换为秒数
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            if (parts.length === 3) {
                const [hours, minutes, secsMillis] = parts;
                const [secs, millis] = secsMillis.split('.');
                return parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(secs) + (parseInt(millis || 0) / 1000);
            }
            return parseFloat(timeStr) || 0;
        };

        function handleMergeFilesSelect(e) {
            const newFiles = Array.from(e.target.files);
            if (selectedFiles.length > 0) {
                // 追加新文件到现有列表
                selectedFiles = [...selectedFiles, ...newFiles];
            } else {
                // 首次选择文件
                selectedFiles = newFiles;
            }
            // 重新渲染文件列表
            renderFileItems();
        }

        function renderFileItems() {
            audioItemsContainer.innerHTML = '';
            audioItemsContainer.className = 'audio-items-container';
            audioItemsContainer.setAttribute('data-sortable', 'true');
            
            selectedFiles.forEach((file, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'audio-item';
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;
                
                // 检测文件类型
                const isVideo = file.type.startsWith('video/');
                const isAudio = file.type.startsWith('audio/');
                
                // 获取当前语言的翻译
                const t = translations[currentLanguage];
                
                itemDiv.innerHTML = `
                    <div class="item-header">
                        <span class="file-type-indicator">${isVideo ? t.video_label : t.audio_label}</span>
                        <span class="file-name">${file.name}</span>
                        <button class="delete-btn" onclick="removeFile(${index})" data-i18n="delete">${t.delete}</button>
                    </div>
                    <div class="item-controls">
                        <div class="form-group">
                            <label for="volume-${index}" data-i18n="volume_adjust">${t.volume_adjust}</label>
                            <input type="number" id="volume-${index}" step="0.1" placeholder="${t.no_adjust}">
                        </div>
                        <div class="form-group">
                            <label data-i18n="trim_settings">${t.trim_settings}</label>
                            <div class="trim-controls">
                                <div class="trim-progress-container">
                                    <input type="range" id="trim-start-${index}" class="trim-slider start-slider" min="0" max="100" value="0" step="0.1">
                                    <div class="trim-progress-bar"></div>
                                    <input type="range" id="trim-end-${index}" class="trim-slider end-slider" min="0" max="100" value="100" step="0.1">
                                </div>
                                <div class="trim-time-inputs">
                                    <label data-i18n="start_time">${t.start_time}</label>
                                    <input type="text" id="start-time-${index}" placeholder="00:00:00.000">
                                    <label data-i18n="end_time">${t.end_time}</label>
                                    <input type="text" id="end-time-${index}" placeholder="00:00:00.000">
                                    <label data-i18n="duration">${t.duration}</label>
                                    <span id="trimmed-duration-${index}">00:00:00.000</span>
                                </div>
                                <button class="play-btn" onclick="playFile(${index})" data-i18n="play">${t.play}</button>
                                <button class="pause-btn" onclick="pauseFile(${index})" data-i18n="pause">${t.pause}</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加拖拽事件监听，但排除trim-controls区域
                itemDiv.addEventListener('dragstart', handleDragStart);
                itemDiv.addEventListener('dragover', handleDragOver);
                itemDiv.addEventListener('drop', handleDrop);
                
                // 为trim-controls区域添加事件阻止，防止触发父元素的拖拽事件
                const trimControls = itemDiv.querySelector('.trim-controls');
                if (trimControls) {
                    trimControls.addEventListener('dragstart', (e) => e.stopPropagation());
                    trimControls.addEventListener('touchstart', (e) => e.stopPropagation());
                    trimControls.addEventListener('mousedown', (e) => e.stopPropagation());
                }
                
                audioItemsContainer.appendChild(itemDiv);
                
                // 加载音频并获取时长
                loadAudioDuration(file, index);
            });
        }

        // 加载音频并获取时长
        function loadAudioDuration(file, index) {
            const audio = new Audio();
            const url = URL.createObjectURL(file);
            audio.src = url;
            
            audio.onloadedmetadata = () => {
                const duration = audio.duration;
                audioObjects[index] = { audio, duration, url };
                
                // 设置结束时间输入框的默认值为总时长
                const endTimeEl = document.getElementById(`end-time-${index}`);
                if (endTimeEl) {
                    endTimeEl.value = formatTime(duration);
                }
                
                // 更新滑块的最大值为实际时长
                const startSlider = document.getElementById(`trim-start-${index}`);
                const endSlider = document.getElementById(`trim-end-${index}`);
                if (startSlider && endSlider) {
                    startSlider.max = duration;
                    endSlider.max = duration;
                    endSlider.value = duration;
                }
                
                // 添加滑块事件监听
                addSliderEventListeners(index);
                // 添加输入框事件监听
                addInputEventListeners(index);
                
                // 更新进度条显示
                updateTrimProgressBar(index);
                // 更新截取后的时长显示
                updateTrimmedDuration(index);
            };
        }

        // 添加滑块事件监听
        function addSliderEventListeners(index) {
            const startSlider = document.getElementById(`trim-start-${index}`);
            const endSlider = document.getElementById(`trim-end-${index}`);
            const itemDiv = document.querySelector(`[data-index="${index}"]`);
            
            // 临时禁用拖拽排序的函数
            const disableDragSort = () => {
                if (itemDiv) {
                    itemDiv.draggable = false;
                }
            };
            
            // 恢复拖拽排序的函数
            const enableDragSort = () => {
                if (itemDiv) {
                    itemDiv.draggable = true;
                }
            };
            
            // 滑块输入事件处理
            const handleStartSliderInput = () => {
                const value = parseFloat(startSlider.value);
                const endSlider = document.getElementById(`trim-end-${index}`);
                if (value > parseFloat(endSlider.value)) {
                    startSlider.value = endSlider.value;
                    return;
                }
                document.getElementById(`start-time-${index}`).value = formatTime(value);
                updateTrimProgressBar(index);
                updateTrimmedDuration(index);
            };
            
            const handleEndSliderInput = () => {
                const value = parseFloat(endSlider.value);
                const startSlider = document.getElementById(`trim-start-${index}`);
                if (value < parseFloat(startSlider.value)) {
                    endSlider.value = startSlider.value;
                    return;
                }
                document.getElementById(`end-time-${index}`).value = formatTime(value);
                updateTrimProgressBar(index);
                updateTrimmedDuration(index);
            };
            
            if (startSlider) {
                // 鼠标事件
                startSlider.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    disableDragSort();
                });
                
                startSlider.addEventListener('mouseup', () => {
                    enableDragSort();
                });
                
                // 触摸事件
                startSlider.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    disableDragSort();
                }, { passive: false });
                
                startSlider.addEventListener('touchend', () => {
                    enableDragSort();
                });
                
                // 输入事件
                startSlider.addEventListener('input', handleStartSliderInput);
            }
            
            if (endSlider) {
                // 鼠标事件
                endSlider.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    disableDragSort();
                });
                
                endSlider.addEventListener('mouseup', () => {
                    enableDragSort();
                });
                
                // 触摸事件
                endSlider.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    disableDragSort();
                }, { passive: false });
                
                endSlider.addEventListener('touchend', () => {
                    enableDragSort();
                });
                
                // 输入事件
                endSlider.addEventListener('input', handleEndSliderInput);
            }
        }

        // 添加输入框事件监听
        function addInputEventListeners(index) {
            const startTimeInput = document.getElementById(`start-time-${index}`);
            const endTimeInput = document.getElementById(`end-time-${index}`);
            
            if (startTimeInput) {
                startTimeInput.addEventListener('input', () => {
                    const value = parseTime(startTimeInput.value);
                    const endSlider = document.getElementById(`trim-end-${index}`);
                    const max = parseFloat(endSlider.max);
                    const endValue = parseFloat(endSlider.value);
                    
                    if (value > endValue) {
                        startTimeInput.value = formatTime(endValue);
                        return;
                    }
                    if (value > max) {
                        startTimeInput.value = formatTime(max);
                        return;
                    }
                    
                    document.getElementById(`trim-start-${index}`).value = value;
                    updateTrimProgressBar(index);
                    updateTrimmedDuration(index);
                });
            }
            
            if (endTimeInput) {
                endTimeInput.addEventListener('input', () => {
                    const value = parseTime(endTimeInput.value);
                    const startSlider = document.getElementById(`trim-start-${index}`);
                    const max = parseFloat(startSlider.max);
                    const startValue = parseFloat(startSlider.value);
                    
                    if (value < startValue) {
                        endTimeInput.value = formatTime(startValue);
                        return;
                    }
                    if (value > max) {
                        endTimeInput.value = formatTime(max);
                        return;
                    }
                    
                    document.getElementById(`trim-end-${index}`).value = value;
                    updateTrimProgressBar(index);
                    updateTrimmedDuration(index);
                });
            }
        }

        // 更新截取进度条
        function updateTrimProgressBar(index) {
            const startSlider = document.getElementById(`trim-start-${index}`);
            const endSlider = document.getElementById(`trim-end-${index}`);
            const progressBar = startSlider?.parentElement?.querySelector('.trim-progress-bar');
            
            if (startSlider && endSlider && progressBar) {
                const start = parseFloat(startSlider.value);
                const end = parseFloat(endSlider.value);
                const max = parseFloat(startSlider.max);
                
                const startPercent = (start / max) * 100;
                const widthPercent = ((end - start) / max) * 100;
                
                progressBar.style.left = `${startPercent}%`;
                progressBar.style.width = `${widthPercent}%`;
            }
        }
        
        // 更新截取后的时长显示
        function updateTrimmedDuration(index) {
            const startSlider = document.getElementById(`trim-start-${index}`);
            const endSlider = document.getElementById(`trim-end-${index}`);
            const trimmedDurationEl = document.getElementById(`trimmed-duration-${index}`);
            
            if (startSlider && endSlider && trimmedDurationEl) {
                const start = parseFloat(startSlider.value);
                const end = parseFloat(endSlider.value);
                const duration = end - start;
                trimmedDurationEl.textContent = formatTime(duration);
            }
        }

        // 删除文件
        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            // 释放音频资源
            if (audioObjects[index]) {
                URL.revokeObjectURL(audioObjects[index].url);
                audioObjects[index].audio.pause();
            }
            audioObjects.splice(index, 1);
            renderFileItems();
        };

        // 拖拽排序功能
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            if (draggedItem !== this) {
                const draggedIndex = parseInt(draggedItem.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // 重新排列文件
                const [movedFile] = selectedFiles.splice(draggedIndex, 1);
                selectedFiles.splice(targetIndex, 0, movedFile);
                
                // 重新排列音频对象
                const [movedAudio] = audioObjects.splice(draggedIndex, 1);
                audioObjects.splice(targetIndex, 0, movedAudio);
                
                // 重新渲染
                renderFileItems();
            }
            
            return false;
        }

        // 播放功能
        window.playFile = function(index) {
            if (audioObjects[index]) {
                const audio = audioObjects[index].audio;
                // 设置播放范围
                const startTime = parseTime(document.getElementById(`start-time-${index}`).value);
                const endTime = parseTime(document.getElementById(`end-time-${index}`).value);
                
                audio.currentTime = startTime;
                audio.play();
                
                // 添加结束监听
                audio.onended = () => {
                    // 播放完成后重置到开始位置
                    audio.currentTime = startTime;
                };
                
                // 添加时间更新监听，确保不超过结束时间
                audio.ontimeupdate = () => {
                    if (audio.currentTime >= endTime) {
                        audio.pause();
                        audio.currentTime = startTime;
                    }
                };
            }
        };

        // 暂停功能
        window.pauseFile = function(index) {
            if (audioObjects[index]) {
                audioObjects[index].audio.pause();
            }
        };

        async function generateMergeVolumeCommand() {
            if (selectedFiles.length === 0) return;

            // 确保FFmpeg已经加载完成
            if (!ffmpegLoaded) {
                await loadFFmpeg();
            }

            const inputFiles = [];
            let outputExt = 'mp3';
            
            // 检测输出格式（使用第一个文件的格式）
            if (selectedFiles.length > 0) {
                const firstFile = selectedFiles[0];
                const isVideo = firstFile.type.startsWith('video/');
                const isAudio = firstFile.type.startsWith('audio/');
                outputExt = isVideo ? 'mp4' : 'mp3';
            }
            
            const outputFileName = getOutputFileName(outputExt);

            // 生成文件列表但不写入文件，文件将在执行命令时写入
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                // 使用原始文件名作为输入，让命令更直观
                const originalName = file.name;
                inputFiles.push(originalName);
            }

            // 生成FFmpeg命令
            let command = [];
            for (let i = 0; i < inputFiles.length; i++) {
                command.push('-i', inputFiles[i]);
            }
            
            // 处理每个文件的截取和音量调整
            let filterComplexParts = [];
            let processedAudioStreams = [];
            let processedVideoStreams = [];
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const volume = document.getElementById(`volume-${i}`).value;
                const startTime = document.getElementById(`start-time-${i}`).value;
                const endTime = document.getElementById(`end-time-${i}`).value;
                
                // 处理音频流
                const audioStreamLabel = `[${i}:a]`;
                const processedAudioLabel = `[a${i}]`;
                
                let audioFilter = '';
                let isFilterApplied = false;
                
                // 添加截取参数
                if (startTime && endTime) {
                    const startSeconds = parseTime(startTime);
                    const endSeconds = parseTime(endTime);
                    const duration = endSeconds - startSeconds;
                    audioFilter += `atrim=start=${startSeconds}:duration=${duration},`;
                    isFilterApplied = true;
                } else if (startTime) {
                    const startSeconds = parseTime(startTime);
                    audioFilter += `atrim=start=${startSeconds},`;
                    isFilterApplied = true;
                } else if (endTime) {
                    const endSeconds = parseTime(endTime);
                    audioFilter += `atrim=end=${endSeconds},`;
                    isFilterApplied = true;
                }
                
                // 添加音量调整
                if (volume) {
                    audioFilter += `volume=${volume}dB`;
                    isFilterApplied = true;
                } else if (audioFilter.endsWith(',')) {
                    // 如果只有截取参数，移除末尾的逗号
                    audioFilter = audioFilter.slice(0, -1);
                }
                
                if (isFilterApplied) {
                    filterComplexParts.push(`${audioStreamLabel}${audioFilter}${processedAudioLabel}`);
                    processedAudioStreams.push(processedAudioLabel);
                } else {
                    processedAudioStreams.push(audioStreamLabel);
                }
                
                // 处理视频流
                if (file.type.startsWith('video/')) {
                    const videoStreamLabel = `[${i}:v]`;
                    const processedVideoLabel = `[v${i}]`;
                    
                    let videoFilter = '';
                    let isFilterApplied = false;
                    
                    // 添加截取参数
                    if (startTime && endTime) {
                        const startSeconds = parseTime(startTime);
                        const endSeconds = parseTime(endTime);
                        const duration = endSeconds - startSeconds;
                        videoFilter += `trim=start=${startSeconds}:duration=${duration},setpts=PTS-STARTPTS,`;
                        isFilterApplied = true;
                    } else if (startTime) {
                        const startSeconds = parseTime(startTime);
                        videoFilter += `trim=start=${startSeconds},setpts=PTS-STARTPTS,`;
                        isFilterApplied = true;
                    } else if (endTime) {
                        const endSeconds = parseTime(endTime);
                        videoFilter += `trim=end=${endSeconds},setpts=PTS-STARTPTS,`;
                        isFilterApplied = true;
                    }
                    
                    if (isFilterApplied) {
                        // 移除末尾的逗号
                        videoFilter = videoFilter.slice(0, -1);
                        filterComplexParts.push(`${videoStreamLabel}${videoFilter}${processedVideoLabel}`);
                        processedVideoStreams.push(processedVideoLabel);
                    } else {
                        processedVideoStreams.push(videoStreamLabel);
                    }
                }
            }
            
            // 添加拼接命令
            if (selectedFiles.length > 1) {
                const hasVideo = selectedFiles.some(file => file.type.startsWith('video/'));
                const hasAudio = selectedFiles.some(file => file.type.startsWith('audio/'));
                
                // 拼接参数
                let concatParams = `concat=n=${selectedFiles.length}`;
                concatParams += hasVideo ? ':v=1' : ':v=0';
                concatParams += hasAudio ? ':a=1' : ':a=0';
                
                // 输入流
                const inputStreams = [...processedVideoStreams, ...processedAudioStreams];
                
                // 输出标签
                let outputLabels = '';
                if (hasVideo) outputLabels += '[outv]';
                if (hasAudio) outputLabels += '[outa]';
                
                filterComplexParts.push(`${inputStreams.join('')}${concatParams}${outputLabels}`);
            }
            
            // 生成完整的filter_complex参数
            if (filterComplexParts.length > 0) {
                command.push('-filter_complex', filterComplexParts.join(';'));
                
                // 根据实际情况添加map参数
                const hasVideo = selectedFiles.some(file => file.type.startsWith('video/'));
                const hasAudio = selectedFiles.some(file => file.type.startsWith('audio/'));
                
                if (hasVideo) command.push('-map', '[outv]');
                if (hasAudio) command.push('-map', '[outa]');
            }
            
            // 添加必要的编码器参数
            const hasVideo = selectedFiles.some(file => file.type.startsWith('video/'));
            const hasAudio = selectedFiles.some(file => file.type.startsWith('audio/'));
            
            if (hasVideo) command.push('-c:v', 'libx264');
            if (hasAudio) {
                command.push('-c:a', 'libmp3lame');
                command.push('-q:a', '4');
            }
            
            // 添加输出文件
            command.push(outputFileName);
            
            // 显示命令并存储上下文（添加ffmpeg前缀）
            ffmpegCommandInput.value = `ffmpeg ${command.join(' ')}`;
            ffmpegCommandInput.readOnly = false;
            commandGroup.classList.remove('hidden');
            currentContext = {
                type: 'merge-volume',
                data: {
                    progressBar: document.getElementById('merge-volume-progress'),
                    files: selectedFiles // 存储files对象，以便在执行命令时使用
                },
                outputExt: outputExt
            };
        }

        // ---------------------- 确认命令并执行 ----------------------
        confirmCommandBtn.addEventListener('click', async () => {
            if (!ffmpegLoaded) {
                alert(translations[currentLanguage].ffmpeg_loading);
                return;
            }

            let command = ffmpegCommandInput.value.split(' ').filter(Boolean);
            if (command.length === 0) return;

            // 移除命令中的"ffmpeg"前缀（如果有）
            if (command[0] === 'ffmpeg') {
                command = command.slice(1);
            }
            
            const outputFileName = command[command.length - 1];
            const progressBar = currentContext.data.progressBar;

            // 监听进度
            ffmpeg.on('progress', (progress) => {
                progressBar.style.width = `${progress.progress * 100}%`;
            });

            // 执行命令
            try {
                // 对于需要多个输入文件的功能，重新写入文件
                if (currentContext.type === 'merge-volume' && currentContext.data.files) {
                    const files = currentContext.data.files;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        // 使用原始文件名作为输入，而不是固定的wav扩展名
                        const originalName = file.name;
                        await ffmpeg.writeFile(originalName, new Uint8Array(await file.arrayBuffer()));
                    }
                }
                
                console.log('执行FFmpeg命令:', command.join(' '));
                const code = await ffmpeg.exec(command);
                
                if (code !== 0) {
                    throw new Error(`FFmpeg执行失败，返回码: ${code}`);
                }
                
                // 等待一点时间确保文件写入完成
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 检查输出文件是否存在
                let data;
                try {
                    data = await ffmpeg.readFile(outputFileName);
                    console.log('输出文件读取成功，大小:', data.length, 'bytes');
                } catch (e) {
                    console.error('无法读取输出文件，可能未生成:', e);
                    // 列出当前目录的文件，用于调试
                    try {
                        const files = await ffmpeg.listDir('/');
                        console.log('虚拟文件系统中的文件:', files);
                    } catch (listErr) {
                        console.error('无法列出文件系统内容:', listErr);
                    }
                    throw new Error(`输出文件 ${outputFileName} 未生成或读取失败`);
                }
                
                // 根据输出文件类型设置正确的MIME类型
                const ext = outputFileName.split('.').pop();
                const mimeType = ext.startsWith('mp4') || ext === 'mov' || ext === 'avi' || ext === 'webm' ? `video/${ext}` : `audio/${ext}`;
                
                const blob = new Blob([data.buffer], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = outputFileName;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(translations[currentLanguage].processing_complete);
            } catch (e) {
                const errorMessage = e.message || (typeof e === 'object' ? JSON.stringify(e) : String(e));
                console.error('FFmpeg执行错误:', e);
                
                // 显示FFmpeg日志用于调试
                if (ffmpegLogs.length > 0) {
                    console.log('FFmpeg执行日志:');
                    ffmpegLogs.forEach(log => console.log(log));
                }
                
                alert(`${translations[currentLanguage].execution_failed}${errorMessage}\n详细日志请查看浏览器控制台`);
            } finally {
                progressBar.style.width = '0%';
                // 清空日志数组
                ffmpegLogs = [];
            }
        });
    </script>
</body>
</html>